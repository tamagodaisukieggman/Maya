from maya import cmds, mel

tail_joints = [u'proxy_tail_01',
 u'proxy_tail_02',
 u'proxy_tail_03',
 u'proxy_tail_04',
 u'proxy_tail_05',
 u'proxy_tail_06',
 u'proxy_tail_07',
 u'proxy_tail_08',
 u'proxy_tail_09',
 u'proxy_tail_10',
 u'proxy_tail_11',
 u'proxy_tail_12',
 u'proxy_tail_13',
 u'proxy_tail_14',
 u'proxy_tail_15',
 u'proxy_tail_16',
 u'proxy_tail_17',
 u'proxy_tail_18']

hip = 'proxy_hip'

tail_ik_h, tail_ik_ee, tail_ik_crv = cmds.ikHandle(sj=tail_joints[0],
                      ee=tail_joints[-1],
                      sol='ikSplineSolver',
                      ns=4,
                      pcv=False)

tail_ik_cvs = cmds.ls('{}.cv[*]'.format(tail_ik_crv), fl=1)

hip_grp = cmds.createNode('transform', ss=1, n='tail_{}_grp'.format(hip))
cmds.xform(hip_grp, t=cmds.xform(hip, q=1, t=1, ws=1), ws=1, a=1)
cmds.setAttr('{}.overrideEnabled'.format(hip_grp), 1)
cmds.setAttr('{}.overrideColor'.format(hip_grp), 17)

tail_ik_joints = []
for i, tic in enumerate(tail_ik_cvs):
    tail_ik_jt = 'tail_ik_{}'.format(str(i).zfill(2))
    tail_ik_joints.append(tail_ik_jt)

    ik_ctrl = cmds.curve(d=1,p=[(0.5,0.5,0.5),(0.5,0.5,-0.5),(-0.5,0.5,-0.5),(-0.5,-0.5,-0.5),(0.5,-0.5,-0.5),(0.5,0.5,-0.5),(-0.5,0.5,-0.5),(-0.5,0.5,0.5),(0.5,0.5,0.5),(0.5,-0.5,0.5),(0.5,-0.5,-0.5),(-0.5,-0.5,-0.5),(-0.5,-0.5,0.5),(0.5,-0.5,0.5),(-0.5,-0.5,0.5),(-0.5,0.5,0.5)],k=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],n='tail_{}_ik_ctrl'.format(str(i).zfill(2)))
    ik_grp = cmds.createNode('transform', ss=1, n='{}_grp'.format(ik_ctrl))
    cmds.createNode('joint', ss=1, n=tail_ik_jt)
    cmds.setAttr('{}.v'.format(tail_ik_jt), 0)

    cmds.parent(ik_ctrl, ik_grp)
    cmds.parent(tail_ik_jt, ik_ctrl)

    cmds.xform(ik_grp, t=cmds.xform(tic, q=1, t=1, ws=1), ws=1, a=1)

    cmds.select('{}.cv[*]'.format(ik_ctrl), r=1)
    cmds.scale(30, 30, 30, r=1)

    cmds.parent(ik_grp, hip_grp)


    cmds.setAttr('{}.rx'.format(ik_ctrl), l=1)
    cmds.setAttr('{}.ry'.format(ik_ctrl), l=1)
    # cmds.setAttr('{}.rz'.format(ik_ctrl), l=1)
    cmds.setAttr('{}.sx'.format(ik_ctrl), l=1)
    cmds.setAttr('{}.sy'.format(ik_ctrl), l=1)
    cmds.setAttr('{}.sz'.format(ik_ctrl), l=1)


crv_sc = cmds.skinCluster(tail_ik_joints, tail_ik_crv, mi=4,sm=0,sw=0.5, n='{}_sc'.format(tail_ik_crv))[0]
crv_bind=cmds.listConnections('{}.bindPose'.format(crv_sc),c=0,d=1,p=0)
if crv_bind:cmds.delete(crv_bind)

tail_half_index = len(tail_joints) / 2

tail_ik_twist_ctrl = cmds.curve( degree = 1,\
            knot = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,\
                    26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,\
                    51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76],\
            point = [(3.6915440258113947, -9.3629908994031406e-017, 1.5290924543994273),\
                     (2.8282092152668978, -1.731777004387582e-016, 2.8282064765013288),\
                     (1.4141046076334489, -8.6588850219379102e-017, 1.4141032382506644),\
                     (1.8457720129056974, -4.6814954497015703e-017, 0.76454622719971366),\
                     (3.6915440258113947, -9.3629908994031406e-017, 1.5290924543994273),\
                     (3.9996918294590156, 5.4462398553035891e-022, -8.8943846656142078e-006),\
                     (1.9998459147295078, 2.7231199276517946e-022, -4.4471923328071039e-006),\
                     (1.8457720129056974, -4.6814954497015703e-017, 0.76454622719971366),\
                     (1.4141046076334489, -8.6588850219379102e-017, 1.4141032382506644),\
                     (0.76454380079422812, -1.130209927361695e-016, 1.8457728843101386),\
                     (1.5290876015884562, -2.26041985472339e-016, 3.6915457686202773),\
                     (2.8282092152668978, -1.731777004387582e-016, 2.8282064765013288),\
                     (1.4141046076334489, -8.6588850219379102e-017, 1.4141032382506644),\
                     (0.76454380079422812, -1.130209927361695e-016, 1.8457728843101386),\
                     (8.3266726846886741e-017, -1.2245520061760724e-016, 1.9998451913297028),\
                     (1.6653345369377348e-016, -2.4491040123521448e-016, 3.9996903826594057),\
                     (1.5290876015884562, -2.26041985472339e-016, 3.6915457686202773),\
                     (0.76454380079422812, -1.130209927361695e-016, 1.8457728843101386),\
                     (8.3266726846886741e-017, -1.2245520061760724e-016, 1.9998451913297028),\
                     (-0.76454380079422712, -1.130209927361695e-016, 1.8457728843101384),\
                     (-1.5290876015884542, -2.26041985472339e-016, 3.6915457686202768),\
                     (1.6653345369377348e-016, -2.4491040123521448e-016, 3.9996903826594057),\
                     (8.3266726846886741e-017, -1.2245520061760724e-016, 1.9998451913297028),\
                     (-0.76454380079422712, -1.130209927361695e-016, 1.8457728843101384),\
                     (-1.4141046076334489, -8.6588850219379053e-017, 1.414103238250664),\
                     (-2.8282092152668978, -1.7317770043875811e-016, 2.8282064765013279),\
                     (-1.5290876015884542, -2.26041985472339e-016, 3.6915457686202768),\
                     (-0.76454380079422712, -1.130209927361695e-016, 1.8457728843101384),\
                     (-1.4141046076334489, -8.6588850219379053e-017, 1.414103238250664),\
                     (-1.8457720129056985, -4.6814954497015678e-017, 0.76454622719971232),\
                     (-3.691544025811397, -9.3629908994031357e-017, 1.5290924543994246),\
                     (-2.8282092152668978, -1.7317770043875811e-016, 2.8282064765013279),\
                     (-1.4141046076334489, -8.6588850219379053e-017, 1.414103238250664),\
                     (-1.8457720129056985, -4.6814954497015678e-017, 0.76454622719971232),\
                     (-1.9998459147295065, 2.7231199284837963e-022, -4.4471923335287489e-006),\
                     (-3.9996918294590129, 5.4462398569675926e-022, -8.8943846670574978e-006),\
                     (-3.691544025811397, -9.3629908994031357e-017, 1.5290924543994246),\
                     (-1.8457720129056985, -4.6814954497015678e-017, 0.76454622719971232),\
                     (-1.9998459147295065, 2.7231199284837963e-022, -4.4471923335287489e-006),\
                     (-1.8457720129056985, 4.6814304039116263e-017, -0.76453560441606883),\
                     (-3.691544025811397, 9.3628608078232526e-017, -1.5290712088321377),\
                     (-3.9996918294590129, 5.4462398569675926e-022, -8.8943846670574978e-006),\
                     (-1.9998459147295065, 2.7231199284837963e-022, -4.4471923335287489e-006),\
                     (-1.8457720129056985, 4.6814304039116263e-017, -0.76453560441606883),\
                     (-1.414104607633448, 8.658982224938694e-017, -1.4141191127053805),\
                     (-2.8282092152668961, 1.7317964449877388e-016, -2.828238225410761),\
                     (-3.691544025811397, 9.3628608078232526e-017, -1.5290712088321377),\
                     (-1.8457720129056985, 4.6814304039116263e-017, -0.76453560441606883),\
                     (-1.414104607633448, 8.658982224938694e-017, -1.4141191127053805),\
                     (-0.76454380079422712, 1.1301958153051444e-016, -1.8457498375728087),\
                     (-1.5290876015884542, 2.2603916306102888e-016, -3.6914996751456175),\
                     (-2.8282092152668961, 1.7317964449877388e-016, -2.828238225410761),\
                     (-1.414104607633448, 8.658982224938694e-017, -1.4141191127053805),\
                     (-0.76454380079422712, 1.1301958153051444e-016, -1.8457498375728087),\
                     (-2.7755575615628914e-017, 1.2246467991473535e-016, -2.0000000000000009),\
                     (-5.5511151231257827e-017, 2.4492935982947069e-016, -4.0000000000000018),\
                     (-1.5290876015884542, 2.2603916306102888e-016, -3.6914996751456175),\
                     (-0.76454380079422712, 1.1301958153051444e-016, -1.8457498375728087),\
                     (-2.7755575615628914e-017, 1.2246467991473535e-016, -2.0000000000000009),\
                     (0.76454380079422657, 1.1301958153051444e-016, -1.845749837572809),\
                     (1.5290876015884531, 2.2603916306102888e-016, -3.6914996751456179),\
                     (-5.5511151231257827e-017, 2.4492935982947069e-016, -4.0000000000000018),\
                     (-2.7755575615628914e-017, 1.2246467991473535e-016, -2.0000000000000009),\
                     (0.76454380079422657, 1.1301958153051444e-016, -1.845749837572809),\
                     (1.4141046076334503, 8.6589822249386927e-017, -1.4141191127053805),\
                     (2.8282092152669005, 1.7317964449877385e-016, -2.828238225410761),\
                     (1.5290876015884531, 2.2603916306102888e-016, -3.6914996751456179),\
                     (0.76454380079422657, 1.1301958153051444e-016, -1.845749837572809),\
                     (1.4141046076334503, 8.6589822249386927e-017, -1.4141191127053805),\
                     (1.8457720129056994, 4.681430403911622e-017, -0.76453560441606694),\
                     (3.6915440258113987, 9.3628608078232439e-017, -1.5290712088321339),\
                     (2.8282092152669005, 1.7317964449877385e-016, -2.828238225410761),\
                     (1.4141046076334503, 8.6589822249386927e-017, -1.4141191127053805),\
                     (1.8457720129056994, 4.681430403911622e-017, -0.76453560441606694),\
                     (1.9998459147295078, 2.7231199276517946e-022, -4.4471923328071039e-006),\
                     (3.9996918294590156, 5.4462398553035891e-022, -8.8943846656142078e-006),\
                     (3.6915440258113987, 9.3628608078232439e-017, -1.5290712088321339)],\
            n = 'tail_ik_twist_{}_ctrl'.format(str(tail_half_index).zfill(2))\
          )

ik_twist_grp = cmds.createNode('transform', ss=1, n='{}_grp'.format(tail_ik_twist_ctrl))
cmds.parent(tail_ik_twist_ctrl, ik_twist_grp)
cmds.parentConstraint(tail_joints[tail_half_index], ik_twist_grp)

cmds.select('{}.cv[*]'.format(tail_ik_twist_ctrl), r=1)
cmds.scale(10, 10, 10, r=1)

cmds.connectAttr('{}.ry'.format(tail_ik_twist_ctrl), '{}.twist'.format(tail_ik_h), f=1)

cmds.setAttr('{}.tx'.format(tail_ik_twist_ctrl), l=1)
cmds.setAttr('{}.ty'.format(tail_ik_twist_ctrl), l=1)
cmds.setAttr('{}.tz'.format(tail_ik_twist_ctrl), l=1)
cmds.setAttr('{}.rx'.format(tail_ik_twist_ctrl), l=1)
cmds.setAttr('{}.rz'.format(tail_ik_twist_ctrl), l=1)
cmds.setAttr('{}.sx'.format(tail_ik_twist_ctrl), l=1)
cmds.setAttr('{}.sy'.format(tail_ik_twist_ctrl), l=1)
cmds.setAttr('{}.sz'.format(tail_ik_twist_ctrl), l=1)

cmds.setAttr('{}.dTwistControlEnable'.format(tail_ik_h), 1)
cmds.setAttr('{}.dWorldUpType'.format(tail_ik_h), 4)
cmds.setAttr('{}.dForwardAxis'.format(tail_ik_h), 2)
cmds.setAttr('{}.dWorldUpAxis'.format(tail_ik_h), 5)
cmds.connectAttr('tail_00_ik_ctrl.worldMatrix[0]', '{0}.dWorldUpMatrix'.format(tail_ik_h), f=1)
cmds.connectAttr('tail_06_ik_ctrl.worldMatrix[0]', '{0}.dWorldUpMatrixEnd'.format(tail_ik_h), f=1)

tail_ik_doNotTouch = 'tail_ik_doNotTouch_grp'
cmds.createNode('transform', ss=1, n=tail_ik_doNotTouch)
cmds.setAttr('{}.v'.format(tail_ik_doNotTouch), 0)

cmds.parent(tail_ik_h, tail_ik_doNotTouch)
cmds.parent(tail_ik_crv, tail_ik_doNotTouch)


cmds.parent(tail_ik_doNotTouch, 'rig')
cmds.parent(hip_grp, 'rig')
cmds.parent(ik_twist_grp, 'rig')
cmds.parentConstraint(hip, hip_grp)
